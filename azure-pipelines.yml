trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  namespace: hello
  yamlPath: hello-deployment.yaml

steps:
# 1. kubeconfig Secure File 다운로드
- task: DownloadSecureFile@1
  name: kubeconfig
  inputs:
    secureFile: 'kubeconfig.yaml'

# 2. 배포 스크립트
- script: |
    echo ">> Export KUBECONFIG"
    export KUBECONFIG=$(kubeconfig.secureFilePath)

    echo ">> Export variables"
    export NAMESPACE=$(namespace)
    export YAML_PATH=$(yamlPath)

    echo ">> Create namespace if not exists"
    kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

    echo ">> Apply YAML to Arc-enabled AKS"
    kubectl apply -f $YAML_PATH -n $NAMESPACE
  displayName: 'Deploy to Azure Arc AKS'